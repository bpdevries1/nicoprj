<?xml version="1.0"?>
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<project name="JMeterYmor" default="install" basedir=".">
  <description>

  </description>

  <!-- location to jmeter source -->
  <!-- @otodo also try with just jmeter binary -->
  <property name="jmeter.root" value="c:/develop/java/jmeter2.6-src"/>
  
  <!-- The version of this file -->
  <property name="version.build" value="$Revision: 1237298 $"/>

  <property file="build-local.properties"/> <!-- allow local overrides -->

  <!-- Where the Sources live -->
  <property name="src.ymor" value="src/ymor"/>
<!--
  <property name="src.dir" value="src"/>
  <property name="src.core" value="src/core"/>
  <property name="src.http" value="src/protocol/http"/>
  <property name="src.ftp" value="src/protocol/ftp"/>
  <property name="src.test" value="test/src"/>
  <property name="src.jdbc" value="src/protocol/jdbc"/>
  <property name="src.java" value="src/protocol/java"/>
  <property name="src.junit" value="src/junit"/>
  <property name="src.components" value="src/components"/>
  <property name="src.functions" value="src/functions"/>
  <property name="src.jorphan" value="src/jorphan"/>
  <property name="src.ldap" value="src/protocol/ldap"/>
  <property name="src.tcp" value="src/protocol/tcp"/>
  <property name="src.examples" value="src/examples"/>
  <property name="src.mail" value="src/protocol/mail"/>
  <property name="src.monitor.components" value="src/monitor/components"/>
  <property name="src.monitor.model" value="src/monitor/model"/>
  <property name="src.jms" value="src/protocol/jms"/>
  <property name="src.report" value="src/reports"/>
-->

  <!-- Where the documentation sources live -->
<!--
  <property name="src.docs" value="xdocs"/>
  <property name="src.css" value="xdocs/css"/>
  <property name="src.images" value="xdocs/images"/>
  <property name="src.demos" value="xdocs/demos"/>
-->
  <!-- Javadoc sources -->
  <path id="srcpaths">
    <pathelement location="${src.ymor}"/>
<!--    
    <pathelement location="${src.core}"/>
    <pathelement location="${src.components}"/>
    <pathelement location="${src.functions}"/>
    <pathelement location="${src.http}"/>
    <pathelement location="${src.ftp}"/>
    <pathelement location="${src.jdbc}"/>
    <pathelement location="${src.java}"/>
    <pathelement location="${src.junit}"/>
    <pathelement location="${src.jorphan}"/>
    <pathelement location="${src.ldap}"/>
    <pathelement location="${src.tcp}"/>
    <pathelement location="${src.examples}"/>
    <pathelement location="${src.mail}"/>
    <pathelement location="${src.monitor.components}"/>
    <pathelement location="${src.monitor.model}"/>
    <pathelement location="${src.jms}"/>
    <pathelement location="${src.report}"/>
-->
  </path>

  <!-- Temporary build directories: where the .class live -->
  <property name="build.dir" value="build"/>
  <property name="build.ymor" value="build/ymor"/>
  <property name="build.res" value="build/res"/>
<!--
  <property name="build.core" value="build/core"/>
  <property name="build.http" value="build/protocol/http"/>
  <property name="build.ftp" value="build/protocol/ftp"/>
  <property name="build.jdbc" value="build/protocol/jdbc"/>
  <property name="build.java" value="build/protocol/java"/>
  <property name="build.junit" value="build/junit"/>
  <property name="build.components" value="build/components"/>
  <property name="build.functions" value="build/functions"/>
  <property name="build.jorphan" value="build/jorphan"/>
  <property name="build.ldap" value="build/protocol/ldap"/>
  <property name="build.mail" value="build/protocol/mail"/>
  <property name="build.tcp" value="build/protocol/tcp"/>
  <property name="build.examples" value="build/examples"/>
  <property name="build.monitor.components" value="build/monitor/components"/>
  <property name="build.monitor.model" value="build/monitor/model"/>
  <property name="build.jms" value="build/protocol/jms"/>
  <property name="build.report" value="build/reports"/>
  <property name="build.test" value="build/test"/>
-->

  <!-- Where the build result .jars will be placed -->
  <property name="dest.jar" value="lib/ext"/>

  <!-- Where the API documentation lives -->
  <property name="dest.docs.api" value="docs/api"/>

  <!-- Where the doc results live -->
  <property name="dest.docs" value="docs"/>
  <property name="dest.printable_docs" value="printable_docs"/>

  <!-- Directory where jars needed for creating documentation live -->
  <property name="lib.doc" value="lib/doc"/>

  <!-- Directory where these 3rd party libraries live -->
  <!-- @otodo staat ymor java ook binnen lib dir? -->
  <property name="lib.dir" value="${jmeter.root}/lib"/>

  <!-- Directory where API spec libraries live -->
  <property name="lib.api" value="${jmeter.root}/lib/api"/>

  <!-- Directory where Optional 3rd party libraries live -->
  <property name="lib.opt" value="${jmeter.root}/lib/opt"/>

  <!-- Where the JMeter build result .jars are placed -->
  <property name="lib.ext" value="${jmeter.root}/lib/ext"/>
  
  <!-- Other stuff -->
  <property name="extras.dir" value="extras"/>

  <!-- Some resources to add to jars -->
  <property name="res.dir" value="res"/>

  <!-- Where the distribution packages will be created -->
  <property name="dist.dir" value="dist"/>

  <!-- Where the Maven artifacts will be created -->
  <property name="maven.dir" value="${dist.dir}/maven"/>

  <!-- Where the Maven template poms are located -->
  <property name="maven.poms" value="res/maven"/>

  <!-- Where the web-site packages will be created -->
  <property name="site.dir" value="site"/>

  <!-- Compilation parameters -->
  <property name="optimize" value="on"/>
  <property name="deprecation" value="off"/>
  <property name="target.java.version" value="1.5"/>
  <property name="src.java.version" value="1.5"/>
  <property name="encoding" value="UTF-8"/>
  <!-- Set test encoding to the same default, but allow override -->
  <property name="test.encoding" value="${encoding}"/>
  <property name="includeAntRuntime" value="false"/>

  <!-- 3rd party libraries to be included in the binary distribution -->
  <property file="build.properties"/> <!-- defines the library version numbers -->

  <property name="resources.meta-inf"      value="${build.res}/META-INF"/>
	
  <patternset id="external.jars.notices">
        <include name="LICENSE"/>
        <include name="NOTICE"/>
        <include name="README"/>
  </patternset>

  <!-- Jars for binary release -->
  <patternset id="external.jars">
    <include name="${lib.dir}/${activation.jar}"/>
    <include name="${lib.dir}/${apache-bsf.jar}"/>
    <include name="${lib.dir}/${apache-jsr223-api.jar}"/>
    <include name="${lib.dir}/${beanshell.jar}"/>
    <include name="${lib.dir}/${avalon-framework.jar}"/>
    <include name="${lib.dir}/${xmlgraphics-commons.jar}"/>
    <include name="${lib.dir}/${commons-codec.jar}"/>
    <include name="${lib.dir}/${commons-collections.jar}"/>
    <include name="${lib.dir}/${commons-httpclient.jar}"/>
    <include name="${lib.dir}/${commons-io.jar}"/>
    <include name="${lib.dir}/${commons-jexl.jar}"/>
    <include name="${lib.dir}/${commons-jexl2.jar}"/>
    <include name="${lib.dir}/${commons-lang.jar}"/>
    <include name="${lib.dir}/${commons-logging.jar}"/>
    <include name="${lib.dir}/${commons-net.jar}"/>
    <include name="${lib.dir}/${excalibur-datasource.jar}"/>
    <include name="${lib.dir}/${excalibur-instrument.jar}"/>
    <include name="${lib.dir}/${excalibur-logger.jar}"/>
    <include name="${lib.dir}/${excalibur-pool.jar}"/>
    <include name="${lib.dir}/${htmllexer.jar}"/>
    <include name="${lib.dir}/${htmlparser.jar}"/>
    <include name="${lib.dir}/${httpclient.jar}"/>
    <include name="${lib.dir}/${httpmime.jar}"/>
    <include name="${lib.dir}/${httpcore.jar}"/>
    <include name="${lib.dir}/${jakarta-oro.jar}"/>
    <include name="${lib.dir}/${javamail.jar}"/>
    <include name="${lib.dir}/${jcharts.jar}"/>
    <include name="${lib.dir}/${jdom.jar}"/>
    <include name="${lib.dir}/${jms.jar}"/>
    <include name="${lib.dir}/${js_rhino.jar}"/>
    <include name="${lib.dir}/${junit.jar}"/>
    <include name="${lib.dir}/${logkit.jar}"/>
    <include name="${lib.dir}/${serializer.jar}"/>
    <include name="${lib.dir}/${soap.jar}"/>
    <include name="${lib.dir}/${tidy.jar}"/>
    <include name="${lib.dir}/${xalan.jar}"/>
    <include name="${lib.dir}/${xerces.jar}"/>
    <include name="${lib.dir}/${xml-apis.jar}"/>
    <include name="${lib.dir}/${xpp3.jar}"/>
    <include name="${lib.dir}/${xstream.jar}"/>
  </patternset>

  <!--
  Optional jars, not included in distribution.
  Any such jars need to be downloaded separately.
  These can be put into ${lib.dir} or ${lib.opt}
  - both of these are included in the build classpath

  Any jars put into ${lib.dir} will be included in
  the classpath used by JMeter to load classes.
  Jars in ${lib.opt} are NOT normally included by JMeter.

  Placing an optional jar in ${lib.opt} means that it
  will be included in the build classpath, but it will
  not be included in the runtime classpath. This is intended
  for testing JMeter without the optional Jar file(s).
  -->

  <!-- Build classpath (includes the optional jar directory) -->
  <path id="classpath">
    <!-- Externally produced jars -->
    <pathelement location="${lib.dir}/${activation.jar}"/>
    <pathelement location="${lib.dir}/${apache-bsf.jar}"/>
    <pathelement location="${lib.dir}/${apache-jsr223-api.jar}"/>
    <pathelement location="${lib.dir}/${beanshell.jar}"/>
    <pathelement location="${lib.dir}/${avalon-framework.jar}"/>
    <pathelement location="${lib.dir}/${xmlgraphics-commons.jar}"/>
    <pathelement location="${lib.dir}/${commons-codec.jar}"/>
    <pathelement location="${lib.dir}/${commons-collections.jar}"/>
    <pathelement location="${lib.dir}/${commons-httpclient.jar}"/>
    <pathelement location="${lib.dir}/${commons-io.jar}"/>
    <pathelement location="${lib.dir}/${commons-jexl.jar}"/>
    <pathelement location="${lib.dir}/${commons-jexl2.jar}"/>
    <pathelement location="${lib.dir}/${commons-lang.jar}"/>
    <pathelement location="${lib.dir}/${commons-logging.jar}"/>
    <pathelement location="${lib.dir}/${commons-net.jar}"/>
    <pathelement location="${lib.dir}/${excalibur-datasource.jar}"/>
    <pathelement location="${lib.dir}/${excalibur-instrument.jar}"/>
    <pathelement location="${lib.dir}/${excalibur-logger.jar}"/>
    <pathelement location="${lib.dir}/${excalibur-pool.jar}"/>
    <pathelement location="${lib.dir}/${htmllexer.jar}"/>
    <pathelement location="${lib.dir}/${htmlparser.jar}"/>
    <pathelement location="${lib.dir}/${httpclient.jar}"/>
    <pathelement location="${lib.dir}/${httpmime.jar}"/>
    <pathelement location="${lib.dir}/${httpcore.jar}"/>
    <pathelement location="${lib.dir}/${jakarta-oro.jar}"/>
    <pathelement location="${lib.dir}/${javamail.jar}"/>
    <pathelement location="${lib.dir}/${jcharts.jar}"/>
    <pathelement location="${lib.dir}/${jdom.jar}"/>
    <pathelement location="${lib.dir}/${jms.jar}"/>
    <pathelement location="${lib.dir}/${js_rhino.jar}"/>
    <pathelement location="${lib.dir}/${junit.jar}"/>
    <pathelement location="${lib.dir}/${logkit.jar}"/>
    <pathelement location="${lib.dir}/${serializer.jar}"/>
    <pathelement location="${lib.dir}/${soap.jar}"/>
    <pathelement location="${lib.dir}/${tidy.jar}"/>
    <pathelement location="${lib.dir}/${xalan.jar}"/>
    <pathelement location="${lib.dir}/${xerces.jar}"/>
    <pathelement location="${lib.dir}/${xml-apis.jar}"/>
    <pathelement location="${lib.dir}/${xpp3.jar}"/>
    <pathelement location="${lib.dir}/${xstream.jar}"/>
    <!-- JMeter generated jars -->
    <fileset dir="${lib.ext}" includes="*.jar"/>
    <!-- Generated jars -->
    <fileset dir="${lib.dir}" includes="jorphan.jar"/>
    <!-- API-only jars-->
    <fileset dir="${lib.api}" includes="*.jar"/>
    <!-- Optional jars -->
    <fileset dir="${lib.opt}" includes="*.jar"/>
  </path>

  <!-- Version info filter set -->
  <tstamp>
    <format property="year" pattern="yyyy" locale="en"/>
  </tstamp>

  <filterset id="version.filters">
    <filter token="YEAR" value="${year}"/>
  </filterset>
	
  <target name="init-version">
    <tstamp/>
    <!--
        JMeter version
        This is overridden for formal releases.
    -->
    <property name="jmeter.version" value="2.6-SNAPSHOT"/>
    <!-- Remember to change "docversion" below if necessary -->
    <condition property="implementation.version"
          value="${jmeter.version} r${svn.revision}" else="${jmeter.version}.${DSTAMP}">
        <isset property="svn.revision"/>
    </condition>
    <property name="display.version" value="${implementation.version}"/>
    <echo level="info">jmeter.version = ${jmeter.version}</echo>
    <echo level="info">display.version = ${display.version}</echo>
    <echo level="info">implementation.version = ${implementation.version}</echo>
  </target>

  <!-- JMeter Javadoc version (own variable is used so can be overriden independently) -->
  <property name="docversion" value="${jmeter.version}"/>

<!--  
  <target name="compile-ymor" depends="compile-jorphan,compile-core" description="Compile components specific to Ymor sampling.">
-->  
  
  <target name="compile-ymor" depends="" description="Compile components specific to Ymor sampling.">
    <mkdir dir="${build.ymor}"/>
    <javac srcdir="${src.ymor}" destdir="${build.ymor}" source="${src.java.version}" optimize="${optimize}" debug="on" target="${target.java.version}"
           includeAntRuntime="${includeAntRuntime}" deprecation="${deprecation}" encoding="${encoding}">
      <include name="**/*.java"/>
      <classpath>
        <pathelement location="${build.jorphan}"/>
        <pathelement location="${build.core}"/>
        <pathelement location="${build.java}"/>
        <path refid="classpath"/>
      </classpath>
    </javac>
  </target>
  
  <target name="compile-protocols" depends="compile-ymor" description="Compile all protocol-specific components."/>

<!--  
  <target name="compile-protocols" depends="compile-http,compile-ftp,compile-jdbc,compile-java,compile-ldap,compile-mail,compile-tcp,compile-ymor" description="Compile all protocol-specific components."/>
-->  

  <target name="compile"
  depends="compile-protocols"
  description="Compile everything."/>

<!--
  <target name="compile"
  depends="_message_3rdParty,compile-core,compile-components,compile-functions,compile-protocols,compile-rmi,compile-monitor,compile-junit,compile-jms,compile-report"
  description="Compile everything."/>
-->  
  <target name="package" depends="compile, prepare-resources, package-only"
     description="Compile everything and create the jars"/>

  <target name="prepare-resources"
     description="Prepare some resources files, update date">
    <mkdir dir="${build.res}" />
  	<mkdir dir="${resources.meta-inf}" />
    <copy todir="${resources.meta-inf}" overwrite="yes" filtering="yes"
        encoding="${encoding}">
      <filterset refid="version.filters"/>
      <fileset dir="${res.dir}/META-INF" >
        <include name="*.license" />
        <include name="*.notice" />
      </fileset>
    </copy>
    <fixcrlf srcdir="${resources.meta-inf}" eol="crlf" includes="*.license *.notice"/>
  </target>

<!--
N.B. Eclipse (and perhaps other Java IDEs) copies all files to the build directory, unless
told otherwise. This means that there might be copies of property and image files in the
build directory. To avoid including the files twice in the jar file, we include only .class
files in the list of files to be processed from the build tree.

Eclipse has been fixed so that it no longer shows files in the build tree in the Open Resource dialogue,
so having duplicates in the build tree no longer causes confusion.

Note: if built from Eclipse, the build directory will include resources and images,
and Eclipse will thus be able to run JMeter from the default path.

If built using Ant, the build tree will not contain any resources, and thus Eclipse will not be able to
run JMeter unless all the JMeter jars are added.

-->
  <target name="package-only" description="Package already-compiled classes (shortcut for IDE users)">
    <manifest file="${build.dir}/MANIFEST_BIN.MF">
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Extension-Name" value=" JMeter"/>
        <attribute name="Specification-Title" value=" Apache JMeter"/>
        <attribute name="Specification-Vendor" value=" Apache Software Foundation"/>
        <attribute name="Implementation-Vendor" value=" Apache Software Foundation"/>
        <attribute name="Implementation-Vendor-Id" value=" org.apache"/>
        <attribute name="Implementation-Version" value="${implementation.version}"/>
        <attribute name="X-Compile-Source-JDK" value="${src.java.version}"/>
        <attribute name="X-Compile-Target-JDK" value="${target.java.version}"/>
    </manifest>

    <manifest file="${build.dir}/MANIFEST_SRC.MF">
       <attribute name="Built-By" value="${user.name}"/>
       <attribute name="Extension-Name" value=" JMeter"/>
       <attribute name="Specification-Title" value=" Apache JMeter"/>
       <attribute name="Specification-Vendor" value=" Apache Software Foundation"/>
       <attribute name="Implementation-Vendor" value=" Apache Software Foundation"/>
       <attribute name="Implementation-Vendor-Id" value=" org.apache"/>
       <attribute name="Implementation-Version" value="${implementation.version}"/>
   </manifest>

    <mkdir dir="${dest.jar}"/>

    <!-- perhaps ought to include a basic jmeter.properties file in one of the jars,
    given that JMeterUtils looks for it if it cannot find the external one
    - otherwise, change utils to ignore it -->

    <!-- ymor functions -->
    <jar jarfile="${dest.jar}/ApacheJMeter_ymor.jar" manifest="${build.dir}/MANIFEST_BIN.MF">
      <zipfileset file="${resources.meta-inf}/default.notice"
        fullpath="META-INF/NOTICE" />
      <zipfileset file="${resources.meta-inf}/default.license"
        fullpath="META-INF/LICENSE" />
      <fileset dir="${build.ymor}" includes="**/*.class" />
      <fileset dir="${src.ymor}" includes="**/*.properties" />
    </jar>
    
  </target>

  <!-- Check the Ant version -->
  <available property="Ant-1.8.0-or-later" classname="org.apache.tools.ant.taskdefs.Local"/>
  <fail message="This build requires Ant 1.8.0 or later" unless="Ant-1.8.0-or-later"/>

  <!-- Check that the 3rd party libraries are present -->
  <target name="_check_3rdparty">
    <condition property="3rdparty.present">
      <and>
          <!-- No need to check all jars; just check a few -->
          <available classpathref="classpath" classname="org.apache.bsf.BSFEngine"/>
          <available classpathref="classpath" classname="org.htmlparser.Parser"/>
          <available classpathref="classpath" classname="com.thoughtworks.xstream.XStream"/>
      </and>
    </condition>
  </target>

  <target name="_message_3rdParty" depends="_check_3rdparty" unless="3rdparty.present">
    <echo>Cannot find all the required 3rd party libraries.</echo>
    <echo>If building from a release, you can get most of them from the binary archive.</echo>
    <echo>Use "ant download_jars" to download any missing jars.</echo>
    <fail message="Cannot find required classes"/>
  </target>

  <target name="install" depends="package" description="Install JMeter. (Compiles code and creates jars)">
    <fixcrlf srcdir="." eol="lf" includes="bin/*.sh bin/jmeter bin/jmeter-server bin/jmeter-report"/>
  </target>

  <!-- lists of files needed for a binary distribution (excluding library files) -->
  <!-- Source files also needed at runtime -->
  <patternset id="dist.common.native">
    <include name="${dest.jar.jmeter}/BeanShell*.bshrc"/>
    <include name="${dest.jar.jmeter}/hc.parameters"/>
    <include name="${dest.jar.jmeter}/log4j.conf"/>
    <include name="${dest.jar.jmeter}/logkit.xml"/>
    <include name="${dest.jar.jmeter}/jmeter.properties"/>
    <include name="${dest.jar.jmeter}/upgrade.properties"/>
    <include name="${dest.jar.jmeter}/saveservice.properties"/>
    <include name="${dest.jar.jmeter}/users.dtd"/>
    <include name="${dest.jar.jmeter}/users.xml"/>
    <!-- Sample override properties files -->
    <include name="${dest.jar.jmeter}/httpclient.parameters"/>
    <include name="${dest.jar.jmeter}/system.properties"/>
    <include name="${dest.jar.jmeter}/user.properties"/>
    <!-- Exclude any files that might be present from testing the release -->
    <exclude name="${dest.jar.jmeter}/*.log"/>
    <include name="${dest.jar.jmeter}/examples/**"/>
    <!-- JMX files are in the non-native section -->
    <exclude name="${dest.jar.jmeter}/examples/*.jmx"/>
    <include name="${extras.dir}/**"/>
    <!-- Binary file types -->
    <exclude name="${extras.dir}/*.jar"/>
    <exclude name="${extras.dir}/*.jpg"/>
    <exclude name="${extras.dir}/*.jmx"/>
    <!-- File types that need to retain their EOL setting -->
    <exclude name="${extras.dir}/*.cmd"/>
    <exclude name="${extras.dir}/*.sh"/>
  </patternset>

  <patternset id="dist.binaries.native">
    <include name="LICENSE"/>
    <include name="NOTICE"/>
    <include name="README"/>
    <patternset refid="dist.common.native"/>
    <!-- Help documentation -->
    <include name="${dest.printable_docs}/**"/>
    <!-- Binary file types -->
    <exclude name="${dest.printable_docs}/**/*.pdf"/>
    <exclude name="${dest.printable_docs}/**/*.jmx"/>
    <!-- We also need the shared CSS for the printable docs -->
    <include name="${dest.docs}/css/**"/>
  </patternset>

  <!-- Source files also needed at runtime -->
  <patternset id="dist.common.non.native">
    <include name="${dest.jar.jmeter}/jmeter*"/>
    <exclude name="${dest.jar.jmeter}/jmeter.properties"/>
    <include name="${dest.jar.jmeter}/mirror-server.*"/>
    <include name="${dest.jar.jmeter}/shutdown.*"/>
    <include name="${dest.jar.jmeter}/stoptest.*"/>
    <!-- Fake SSL cert for JMeter proxy recorder in https -->
    <include name="${dest.jar.jmeter}/proxyserver.jks"/>
    <!-- Exclude any files that might be present from testing the release -->
    <exclude name="${dest.jar.jmeter}/*.log"/>
    <include name="${dest.jar.jmeter}/examples/*.jmx"/>
    <include name="${extras.dir}/*.jar"/>
    <include name="${extras.dir}/*.jpg"/>
    <include name="${extras.dir}/*.jmx"/>
    <!-- File types that need to retain their EOL setting -->
    <include name="${extras.dir}/*.cmd"/>
    <include name="${extras.dir}/*.sh"/>
  </patternset>

  <patternset id="dist.binaries.non.native">
    <patternset refid="dist.common.non.native"/>
    <include name="${dest.jar}/"/>
    <include name="${lib.dir}/bshclient.jar"/>
    <include name="${lib.dir}/jorphan.jar"/>
    <include name="${lib.dir}/junit/test.jar"/>
    <include name="${dest.jar.jmeter}/ApacheJMeter.jar"/>
    <!-- Help documentation, binary files -->
    <include name="${dest.printable_docs}/**/*.pdf"/>
    <include name="${dest.printable_docs}/**/*.jmx"/>
    <!-- We also need the shared images for the printable docs -->
    <include name="${dest.docs}/images/**"/>
  </patternset>

  <!--
      List of Unix executable files in the binary distribution
      These need special handling to create the correct file mode
  -->
  <property name="dist.executables"
    value="${dest.jar.jmeter}/jmeter ${dest.jar.jmeter}/jmeter-server ${dest.jar.jmeter}/*.sh"/>

  <!-- List of files in source distribution that are eol=native -->
  <!--
  N.B. dist.sources[.non].native sets exclude source files present in dist.binaries[.non].native
  so that the nightly build src archive does not duplicate stuff in the binary archive
  (This may change, as the overlap does not waste much space)
  -->
  <patternset id="dist.sources.native">
    <include name="LICENSE"/>
    <include name="NOTICE"/>
    <include name="README"/>
    <include name="${src.dir}/**"/>
    <!-- Exclude binary types -->
    <exclude name="**/*.gif"/>
    <exclude name="**/*.jpg"/>
    <exclude name="**/*.png"/>
    <include name="${src.docs}/**"/>
  	<!-- Include some resources -->
  	<include name="${res.dir}/**"/>
    <!-- Exclude binary types (and JMX/JTL, which are not OS-dependent) -->
    <exclude name="${src.docs}/images/**"/>
    <exclude name="${src.docs}/**/*.jmx"/>
    <exclude name="${src.docs}/**/*.odt"/>
    <exclude name="${src.docs}/**/*.pdf"/>
    <exclude name="${src.docs}/**/*.sxi"/>
    <exclude name="${src.docs}/**/*.sxw"/>
    <include name="${src.test}/**"/>
    <include name="build.xml"/>
    <include name="build.properties"/>
    <include name="${dest.jar.jmeter}/testfiles/**"/>
    <exclude name="${dest.jar.jmeter}/testfiles/*.jmx"/>
    <exclude name="${dest.jar.jmeter}/testfiles/*.jtl"/>
    <!-- These are generated with EOL=LF -->
    <exclude name="${dest.jar.jmeter}/testfiles/BatchTestLocal.xml"/>
    <exclude name="${dest.jar.jmeter}/testfiles/Bug50898.xml"/>
    <exclude name="${dest.jar.jmeter}/testfiles/Bug52310.xml"/>
    <!-- Ignore unit test output -->
    <exclude name="${dest.jar.jmeter}/testfiles/*.out"/>
    <exclude name="${dest.jar.jmeter}/testfiles/Sample_*.png"/>
    <include name="eclipse.classpath"/>
    <include name="eclipse.readme"/>
    <include name="checkstyle.xml"/>
    <include name="${lib.dir}/aareadme.txt"/>
    <include name="fb-*.x*"/>
    <!-- Make sure that the lib/opt directory is included in the archives -->
    <include name="${lib.opt}/README.txt"/>
  </patternset>

  <!-- Non-native items -->
  <patternset id="dist.sources.non.native">
    <include name="${src.dir}/**/*.gif"/>
    <include name="${src.dir}/**/*.jpg"/>
    <include name="${src.dir}/**/*.png"/>
    <include name="${src.docs}/images/**"/>
    <include name="${src.docs}/**/*.jmx"/>
    <include name="${src.docs}/**/*.odt"/>
    <include name="${src.docs}/**/*.pdf"/>
    <include name="${src.docs}/**/*.sxi"/>
    <include name="${src.docs}/**/*.sxw"/>
    <include name="${dest.jar.jmeter}/testfiles/*.jmx"/>
    <include name="${dest.jar.jmeter}/testfiles/*.jtl"/>
    <!-- These are generated with EOL=LF -->
    <include name="${dest.jar.jmeter}/testfiles/BatchTestLocal.xml"/>
    <include name="${dest.jar.jmeter}/testfiles/Bug50898.xml"/>
    <include name="${dest.jar.jmeter}/testfiles/Bug52310.xml"/>
    <!-- Include the image files used in parsing / embedded download tests -->
    <include name="${dest.jar.jmeter}/testfiles/**/*.gif"/>
    <include name="${dest.jar.jmeter}/testfiles/**/*.jpg"/>
    <include name="${dest.jar.jmeter}/testfiles/**/*.png"/>
  </patternset>

    <!-- Convert eol:native source files to appropriate format if required -->
    <target name="_filter" unless="native.${eoltype}">
        <property name="workdir" value="${dist.dir}/${eoltype}"/>
        <echo level="info">Converting work files to eol=${eoltype} in ${workdir}</echo>
        <mkdir dir="${workdir}"/>
        <copy includeemptydirs="false" todir="${workdir}">
            <fileset dir=".">
                <patternset refid="${fileset}"/>
            </fileset>
            <filterchain>
                <fixcrlf encoding="${encoding}" fixlast="false" eol="${eoltype}" srcdir="${workdir}"/>
            </filterchain>
        </copy>
    </target>

    <!-- Files to be included in full source download -->
    <patternset id="dist_src_files_native">
        <patternset refid="dist.sources.native"/>
        <patternset refid="dist.common.native"/>
    </patternset>

    <patternset id="dist_src_files_non_native">
        <patternset refid="dist.sources.non.native"/>
        <patternset refid="dist.common.non.native"/>
    </patternset>

    <!-- Files to be included in full binary download -->
    <patternset id="dist_bin_files_native">
        <patternset refid="dist.binaries.native"/>
        <patternset refid="external.jars.notices"/>
        <!-- We don't need the site docs, but we do want Javadoc (e.g. for BeanShell) -->
        <include name="${dest.docs.api}/**"/>
        <exclude name="${dest.docs.api}/resources/**"/>
    </patternset>

    <patternset id="dist_bin_files_non_native">
        <patternset refid="dist.binaries.non.native"/>
        <patternset refid="external.jars"/>
        <include name="${dest.docs.api}/resources/**"/>
    </patternset>

    <!-- NOTE: the site documents are not included in either archive -->

    <target name="check-versions" unless="disable-check-versions">
        <fail message="jmeter.version must be defined" unless="jmeter.version"/>
        <fail message="svn.revision must be defined" unless="svn.revision"/>
        <local         name="version.match"/>
        <condition property="version.match">
            <resourcecontains resource="${src.core}/org/apache/jmeter/util/JMeterVersion.java"
            	substring='VERSION = "${jmeter.version}";'/>
        </condition>
        <fail message="jmeter.version must be same as JMeterVersion.VERSION" unless="version.match"/>
    </target>

    <target name="_eolcheck">
        <!-- Determine if the native format is CRLF or LF (or neither) -->
        <condition property="native.lf">
            <os family="unix"/>
        </condition>
        <condition property="native.crlf">
            <os family="dos"/>
        </condition>
        <!-- Define native.dir.x as either the source or updated directory as appropriate -->
        <condition property="native.dir.lf" value="." else="${dist.dir}/lf">
            <isset property="native.lf"/>
        </condition>
        <condition property="native.dir.crlf" value="." else="${dist.dir}/crlf">
            <isset property="native.crlf"/>
        </condition>
        <echoproperties prefix="native"></echoproperties>
    </target>

    <!-- Internal target -->
    <target name="_distribution" depends="check-versions,_eolcheck,check_jars">
    <property name="dist.name" value="apache-jmeter-${jmeter.version}"/>
    <property name="pack.name" value="${dist.name}"/>
    <echo level="info">Creating JMeter distribution ${dist.name} ${svn.revision}</echo>
    <mkdir dir="${dist.dir}"/>

    <!-- Delete work directories just in case -->
    <delete dir="${dist.dir}/crlf" quiet="true"/>
    <delete dir="${dist.dir}/lf" quiet="true"/>

    <!-- Runtime archives -->
    <antcall target="_filter">
        <param name="eoltype" value="lf"/>
        <param name="fileset" value="dist_bin_files_native"/>
    </antcall>

    <tar destfile="${dist.dir}/${pack.name}.tar" longfile="gnu">
      <tarfileset dir="." prefix="${dist.name}" excludes="${dist.executables}" defaultexcludes="yes">
         <patternset refid="dist_bin_files_non_native"/>
      </tarfileset>
      <tarfileset mode="755" includes="${dist.executables}" dir="." prefix="${dist.name}" defaultexcludes="yes"/>
      <tarfileset dir="${native.dir.lf}" prefix="${dist.name}">
         <patternset refid="dist_bin_files_native"/>
      </tarfileset>
    </tar>
    <!-- Delete work directory (may not exist) -->
    <delete dir="${dist.dir}/lf" quiet="true"/>

    <gzip zipfile="${dist.dir}/${pack.name}.tgz" src="${dist.dir}/${pack.name}.tar" />
    <!-- no longer needed -->
    <delete file="${dist.dir}/${pack.name}.tar"/>
    <antcall target="_hash">
        <param name="path" value="${dist.dir}/${dist.name}.tgz"/>
    </antcall>

    <antcall target="_filter">
        <param name="eoltype" value="crlf"/>
        <param name="fileset" value="dist_bin_files_native"/>
    </antcall>
    <zip  zipfile="${dist.dir}/${pack.name}.zip">
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist_bin_files_non_native"/>
      </zipfileset>
      <zipfileset dir="${native.dir.crlf}" prefix="${dist.name}">
         <patternset refid="dist_bin_files_native"/>
      </zipfileset>
    </zip>
    <antcall target="_hash">
        <param name="path" value="${dist.dir}/${dist.name}.zip"/>
    </antcall>
    <!-- Delete work directory (may not exist) -->
    <delete dir="${dist.dir}/crlf" quiet="true"/>

    <!-- Source archives -->
    <antcall target="_filter">
        <param name="eoltype" value="lf"/>
        <param name="fileset" value="dist_src_files_native"/>
    </antcall>
    <tar destfile="${dist.dir}/${pack.name}_src.tar" longfile="gnu">
      <tarfileset dir="${native.dir.lf}" prefix="${dist.name}">
         <patternset refid="dist_src_files_native"/>
      </tarfileset>
      <tarfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist_src_files_non_native"/>
      </tarfileset>
    </tar>
    <!-- Delete work directory (may not exist) -->
    <delete dir="${dist.dir}/lf" quiet="true"/>

    <gzip zipfile="${dist.dir}/${pack.name}_src.tgz" src="${dist.dir}/${pack.name}_src.tar" />
    <!-- no longer needed -->
    <delete file="${dist.dir}/${pack.name}_src.tar"/>
    <antcall target="_hash">
        <param name="path" value="${dist.dir}/${dist.name}_src.tgz"/>
    </antcall>

    <antcall target="_filter">
        <param name="eoltype" value="crlf"/>
        <param name="fileset" value="dist_src_files_native"/>
    </antcall>

    <zip  zipfile="${dist.dir}/${pack.name}_src.zip">
      <zipfileset dir="${native.dir.crlf}" prefix="${dist.name}">
         <patternset refid="dist_src_files_native"/>
      </zipfileset>
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist_src_files_non_native"/>
      </zipfileset>
    </zip>
    <antcall target="_hash">
        <param name="path" value="${dist.dir}/${dist.name}_src.zip"/>
    </antcall>
    <!-- Delete work directory (may not exist) -->
    <delete dir="${dist.dir}/crlf" quiet="true"/>
</target>

  <!-- Set up files for distribution to Maven via Nexus -->
  <target name="_dist_maven" depends="init-version">
    <!-- Ensure there aren't any stale files left -->
    <delete dir="${maven.dir}" includes="*.pom" quiet="true"/>
    <echo>Updating POM files to version ${jmeter.version}</echo>
    <copy todir="${maven.dir}">
        <fileset dir="${maven.poms}" includes="*.pom"/>
        <filterset>
            <filter token="MAVEN.DEPLOY.VERSION" value="${jmeter.version}"/>
        </filterset>
    </copy>
    <delete dir="${maven.dir}" includes="*.jar" quiet="true"/>
    <echo>Copying jar files ready for signing</echo>
    <copy todir="${maven.dir}">
      <fileset dir="${dest.jar}" includes="ApacheJMeter*.jar"/>
      <fileset dir="${dest.jar.jmeter}" includes="ApacheJMeter.jar"/>
      <fileset dir="${lib.dir}" includes="jorphan.jar"/>
    </copy>
    <copy tofile="${maven.dir}/ApacheJMeter_junit-test.jar" file="${lib.dir}/junit/test.jar"/>
    <!-- 
        Create the Maven jar needed to hold configuration data
        Cannot be added to any of the other jars as that would cause problems for stand-alone JMeter usage.
    -->
    <jar jarfile="${maven.dir}/ApacheJMeter_config.jar" manifest="${build.dir}/MANIFEST_SRC.MF">
        <zipfileset file="${resources.meta-inf}/default.notice"
          fullpath="META-INF/NOTICE" />
        <zipfileset file="${resources.meta-inf}/default.license"
          fullpath="META-INF/LICENSE" />
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="*.bshrc"/>
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="*.parameters"/>
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="*.properties"/>
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="log4j.conf"/>
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="logkit.xml"/>
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="proxyserver.jks"/>
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="users.dtd"/>
      <zipfileset dir="${dest.jar.jmeter}" prefix="bin" includes="users.xml"/>
    </jar>
  </target>

  <!-- 
        Upload jars/poms/sigs to local (/target), snapshots or releases repos; default is local.
        By default, deploys the artifacts to target/deploy under JMeter home.

        Must have Maven 2.2.1 or Maven 3.0.x installed.
        The environment variable M2_HOME must point to a suitable Maven installation (2.2.1+)

        For remote deployment, username/password will need to be set up in the appropriate
        "server" entries in the Maven settings.xml file, i.e. under:

        apache.snapshots.https
        apache.releases.https

        Pre-requisite:
        The jars and poms need to be made available. If this has not already been done as part of
        creating the distribution (e.g. a snapshot release is desired), then invoke the following:

              ant _dist_maven -Djmeter.version=2.6-SNAPSHOT

        For non-SNAPSHOT releases, the jars and poms need to be signed (TODO document how!!)

        Usage:
              ant maven_upload [-DrepoType=snapshots|releases]
  -->
  <target name="maven_upload" description="Upload jars and poms (and sigs if present).">

    <property environment="env"/>
    <!-- According to http://maven.apache.org/download.html#Installation M2_HOME applies to Maven 2.2.1 and 3.0.x -->
    <condition property="maven.present">
      <isset property="env.M2_HOME"/>
    </condition>
    <fail unless="${maven.present}" message="The environment variable M2_HOME must point to a Maven installation"/>

    <property name="maven.home" value="${env.M2_HOME}"/>

    <!-- file repo url -->
    <property name="file.url" value="file:${basedir}/target/deploy"/>

    <!-- Apache Nexus snapshots repo url -->
    <property name="snapshots.url" value="https://repository.apache.org/content/repositories/snapshots"/>
    <!-- Apache Nexus snapshots repo name for servers section of settings.xml -->
    <property name="snapshots.repositoryId" value="apache.snapshots.https"/>

    <!-- Apache Nexus releases repo url -->
    <property name="releases.url" value="https://repository.apache.org/service/local/staging/deploy/maven2"/>
    <!-- Apache Nexus releases repo name for servers section of settings.xml -->
    <property name="releases.repositoryId" value="apache.releases.https"/>

    <property name="repoType" value="file"/>

    <!-- Hack to skip defining files/types/classifiers -->
    <condition property="XX" value="" else="XX">
      <and>
        <available file="${maven.dir}/jorphan.jar.asc"/>
        <available file="${maven.dir}/jorphan.pom.asc"/>
        <!-- Don't upload sigs to snapshots repo (might mislead users) -->
        <not>
          <equals arg1="snapshots" arg2="@repoType"/>
        </not>
      </and>
    </condition>

    <!-- Derived from:
         http://maven.apache.org/ant-tasks/examples/mvn.html#Using_the_Java_Task 
    -->
    <macrodef name="deployfile">
      <attribute name="stem" />
      <attribute name="packaging" default="jar"/>
      <attribute name="type" default="${repoType}"/>
      <attribute name="url" default="${@{type}.url}"/>
      <attribute name="repositoryId" default="${@{type}.repositoryId}"/>
      <sequential>
        <java classname="org.codehaus.classworlds.Launcher"
              fork="true"
              dir="${basedir}"
              failonerror="true">
          <jvmarg value="-Xmx512m"/>
          <classpath>
            <fileset dir="${maven.home}/boot">
              <include name="*.jar" />
            </fileset>
            <fileset dir="${maven.home}/lib">
              <include name="*.jar" />
            </fileset>
          </classpath>
          <sysproperty key="classworlds.conf" value="${maven.home}/bin/m2.conf" />
          <sysproperty key="maven.home" value="${maven.home}" />
          <arg value="--batch-mode"/>
          <!--arg value="-X"/-->
          <arg value="-DgeneratePom=false"/>
          <arg value="-Durl=@{url}"/>
          <arg value="-DrepositoryId=@{repositoryId}"/>
          <arg value="-DpomFile=${maven.dir}/@{stem}.pom"/>
          <arg value="-Dpackaging=@{packaging}"/>
          <arg value="-Dfile=${maven.dir}/@{stem}.${packaging}"/>
          <!--
               The XX property is a hack to avoid creating conditional code.
               It will be empty if the sigs exist; if not it will be XX which will be ignored by Maven 
          -->
          <!-- If packaging == pom, this will just upload the pom twice. Simpler than trying to conditionalise. -->
          <arg value="-D${XX}files=${maven.dir}/@{stem}.${packaging}.asc,${maven.dir}/@{stem}.pom.asc"/>
          <arg value="-D${XX}types=${packaging}.asc,pom.asc"/>
          <arg value="-D${XX}classifiers=,"/>
          <!-- Need at least version 2.7 of the plugin to upload additional files-->
          <arg value="org.apache.maven.plugins:maven-deploy-plugin:2.7:deploy-file"/>
        </java>
      </sequential>
    </macrodef>


    <deployfile stem="ApacheJMeter_parent" packaging="pom"/>
    <deployfile stem="jorphan"/>
    <deployfile stem="ApacheJMeter"/>
    <deployfile stem="ApacheJMeter_components"/>
    <deployfile stem="ApacheJMeter_config"/>
    <deployfile stem="ApacheJMeter_core"/>
    <deployfile stem="ApacheJMeter_ftp"/>
    <deployfile stem="ApacheJMeter_functions"/>
    <deployfile stem="ApacheJMeter_http"/>
    <deployfile stem="ApacheJMeter_java"/>
    <deployfile stem="ApacheJMeter_jdbc"/>
    <deployfile stem="ApacheJMeter_jms"/>
    <deployfile stem="ApacheJMeter_junit"/>
    <deployfile stem="ApacheJMeter_junit-test"/>
    <deployfile stem="ApacheJMeter_ldap"/>
    <deployfile stem="ApacheJMeter_mail"/>
    <deployfile stem="ApacheJMeter_monitors"/>
    <deployfile stem="ApacheJMeter_report"/>
    <deployfile stem="ApacheJMeter_tcp"/>
  </target>

  <target name="pack-src" depends="init-version">
    <property name="dist.name" value="apache-jmeter-${jmeter.version}"/>
    <antcall target="_pack-source"/>
  </target>

  <target name="pack-dist" depends="init-version">
    <property name="dist.name" value="apache-jmeter-${jmeter.version}"/>
    <antcall target="_pack-binaries"/>
    <antcall target="_pack-libraries"/>
    <antcall target="_pack-javadoc"/>
    <antcall target="_pack-source"/>
  </target>

  <!-- As pack-dist but without javadoc -->
  <target name="pack-nightly" depends="init-version">
    <property name="dist.name" value="apache-jmeter-${jmeter.version}"/>
    <antcall target="_pack-binaries"/>
    <antcall target="_pack-libraries"/>
    <antcall target="_pack-source"/>
  </target>

   <target name="_pack-binaries">
    <property name="pack.name" value="${dist.name}_bin"/>
    <mkdir dir="${dist.dir}"/>
    <tar destfile="${dist.dir}/${pack.name}.tar" longfile="gnu">
      <tarfileset dir="." prefix="${dist.name}" excludes="${dist.executables}" defaultexcludes="yes">
        <patternset refid="dist.binaries.native"/>
      </tarfileset>
      <tarfileset dir="." prefix="${dist.name}" excludes="${dist.executables}" defaultexcludes="yes">
        <patternset refid="dist.binaries.non.native"/>
      </tarfileset>
      <tarfileset mode="755" includes="${dist.executables}" dir="." prefix="${dist.name}" defaultexcludes="yes"/>
    </tar>
    <gzip zipfile="${dist.dir}/${pack.name}.tgz" src="${dist.dir}/${pack.name}.tar" />
    <!-- no longer needed -->
    <delete file="${dist.dir}/${pack.name}.tar"/>
    <zip  zipfile="${dist.dir}/${pack.name}.zip">
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist.binaries.native"/>
      </zipfileset>
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist.binaries.non.native"/>
      </zipfileset>
    </zip>
    </target>

   <target name="_pack-libraries">
    <property name="pack.name" value="${dist.name}_lib"/>
    <mkdir dir="${dist.dir}"/>
    <tar destfile="${dist.dir}/${pack.name}.tar" longfile="gnu">
      <tarfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="external.jars.notices"/>
      </tarfileset>
      <tarfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="external.jars"/>
      </tarfileset>
    </tar>
    <gzip zipfile="${dist.dir}/${pack.name}.tgz" src="${dist.dir}/${pack.name}.tar" />
    <!-- no longer needed -->
    <delete file="${dist.dir}/${pack.name}.tar"/>
    <zip  zipfile="${dist.dir}/${pack.name}.zip">
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="external.jars.notices"/>
      </zipfileset>
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="external.jars"/>
      </zipfileset>
    </zip>
    </target>

   <target name="_pack-javadoc">
    <property name="pack.name" value="${dist.name}_api"/>
    <mkdir dir="${dist.dir}"/>
    <tar destfile="${dist.dir}/${pack.name}.tar" longfile="gnu">
      <tarfileset includes="${dest.docs.api}" dir="." prefix="${dist.name}" defaultexcludes="yes"/>
    </tar>
    <gzip zipfile="${dist.dir}/${pack.name}.tgz" src="${dist.dir}/${pack.name}.tar" />
    <!-- no longer needed -->
    <delete file="${dist.dir}/${pack.name}.tar"/>
    <zip  zipfile="${dist.dir}/${pack.name}.zip">
       <zipfileset includes="${dest.docs.api}" dir="." prefix="${dist.name}" defaultexcludes="yes"/>
    </zip>
    </target>

   <target name="_pack-source">
    <property name="pack.name" value="${dist.name}_src"/>
    <mkdir dir="${dist.dir}"/>
    <tar destfile="${dist.dir}/${pack.name}.tar" longfile="gnu">
      <tarfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist.sources.native"/>
      </tarfileset>
      <tarfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist.sources.non.native"/>
      </tarfileset>
    </tar>
    <gzip zipfile="${dist.dir}/${pack.name}.tgz" src="${dist.dir}/${pack.name}.tar" />
    <!-- no longer needed -->
    <delete file="${dist.dir}/${pack.name}.tar"/>
    <zip  zipfile="${dist.dir}/${pack.name}.zip">
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist.sources.native"/>
      </zipfileset>
      <zipfileset dir="." prefix="${dist.name}" defaultexcludes="yes">
        <patternset refid="dist.sources.non.native"/>
      </zipfileset>
    </zip>
    </target>

    <!-- Create a zip of all resource files for translators -->
    <target name="pack-resources">
        <mkdir dir="${dist.dir}"/>
        <zip  zipfile="${dist.dir}/resources.zip">
          <zipfileset dir="." defaultexcludes="yes">
            <patternset excludes="${src.dir}/examples/**" />
            <patternset includes="${src.dir}/**/*Resources.properties" />
            <patternset includes="${src.dir}/**/messages.properties" />
            <patternset includes="${src.dir}/**/i18nedit.properties" />
          </zipfileset>
        </zip>
    </target>

<!--
    Utility target to create MD5 checksums in standard format (with *filename)
    Usage:
    <antcall target="_hash">
        <param name="path" value="archive.jar|zip|gz"/>
    </antcall>
-->

    <target name="_hash" unless="hash.skip">
        <echo message="Creating MD5 for ${path}"/>
        <basename property="_base" file="${path}"/>
        <checksum algorithm="MD5" file="${path}" property="md5"/>
        <echo message="${md5} *${_base}" file="${path}.md5"/>
        <echo message="Creating SHA for ${path}"/>
        <checksum algorithm="SHA" file="${path}" property="sha"/>
        <echo message="${sha} *${_base}" file="${path}.sha"/>
    </target>

  <!--
  Clean-docs and clean-apidocs can be used to empty the docs or docs/api directories.
  This should be done before regenerating the documents for a release so that any obsolete files are detected.
  -->
  <target name="clean-docs">
    <delete>
        <fileset dir="${dest.docs}" excludes=".svn/** api/**"/>
    </delete>
  </target>

  <!-- Use this before running docs-print to ensure image files are synchronised -->
  <target name="clean-docs-images">
      <delete>
          <fileset dir="${dest.docs}/images" excludes=".svn/**"/>
      </delete>
  </target>

  <target name="clean-apidocs">
    <delete>
        <fileset dir="${dest.docs.api}" excludes=".svn/**"/>
    </delete>
  </target>

  <target name="clean" description="Clean up to force a build from source.">
    <delete quiet="true">
        <fileset dir="${dest.jar.jmeter}" includes="ApacheJMeter.jar"/>
        <fileset dir="${lib.dir}" includes="jorphan.jar"/>
        <fileset dir="${lib.dir}" includes="bshclient.jar"/>
        <fileset dir="${dest.jar}" includes="*.jar"/>
        <fileset dir="${build.dir}"/>
        <fileset dir="${dest.printable_docs}"/>
        <fileset dir="${dist.dir}"/>
        <fileset dir="${site.dir}"/>
    </delete>
  </target>

  <target name="clean-dist" description="Clean up dist directory.">
    <delete quiet="true">
        <fileset dir="${dist.dir}"/>
    </delete>
  </target>

  <target name="docs-api" description="Generate the API documentation.">
    <tstamp>
      <!-- Used to ensure end-year is up to date -->
      <format property="THISYEAR" pattern="yyyy"/>
    </tstamp>
    <mkdir dir="${dest.docs.api}"/>
    <delete quiet="true">
        <fileset dir="${dest.docs.api}" includes="**/*.html"/>
    </delete>
    <echo level="info">Updating overview to ${docversion}</echo>
    <replaceregexp match="version [\d.a-zA-Z]+"
                 encoding="${encoding}"
                 replace="version ${docversion}"
                 flags="g" byline="true">
       <fileset dir="${src.docs}" includes="overview.html" />
    </replaceregexp>
    <javadoc
      sourcepathref="srcpaths"
      overview="${src.docs}/overview.html"
      additionalparam="-breakiterator"
      destdir="${dest.docs.api}"
      verbose="false"
      protected="yes"
      version="yes"
      doctitle="Apache JMeter API"
      windowtitle="Apache JMeter API"
      header="&lt;b&gt;Apache JMeter&lt;/b&gt;"
      bottom="Copyright &amp;#xA9; 1998-${THISYEAR} Apache Software Foundation. All Rights Reserved."
      packagenames="org.apache.jmeter.*,org.apache.jorphan.*"
      excludepackagenames="org.apache.jorphan.timer">
      <classpath refid="classpath"/>
      <link href="http://download.oracle.com/javase/1.5.0/docs/api/"/>
    </javadoc>
  </target>

<!--
    Run Doccheck: See http://java.sun.com/j2se/javadoc/doccheck/docs/DocCheck.html
    and http://java.sun.com/j2se/javadoc/doccheck/
    Download the doclet, and put the jar in lib/opt.
    Output is in reports/ directory
-->
<target name="docs-check">
    <javadoc sourcepathref="srcpaths"
    destdir="reports"
    docletpath="${lib.opt}/doccheck.jar"
    packagenames="org.apache.jmeter.*,org.apache.jorphan.*"
    excludepackagenames="org.apache.jmeter.util.keystore,org.apache.jorphan.timer">
      <classpath refid="classpath"/>
      <doclet name="com.sun.tools.doclets.doccheck.DocCheck">
        <!--
            -execDepth: 1=org.* 2=org.apache.* 3+=org.apache.jmeter.*
            -evident does not seem to work
         -->
        <param name="-execDepth" value="3"/>
        <param name="-evident" value="4"/>
      </doclet>
    </javadoc>
</target>

    <!-- Macro is needed to be able to perform indirect evaluation of property names -->
    <macrodef name="process_jarfile">
        <attribute name="jarname"/>
        <attribute name="dest.dir" default="${lib.dir}"/>
        <sequential>
            <!-- Call all possible targets; these are only executed if the appropriate property is set -->
            <antcall target="_check_exists">
                <param name="file" value="@{dest.dir}/${@{jarname}.jar}"/>
                <param name="loc" value="${@{jarname}.loc}"/>
                <param name="jar" value="${@{jarname}.jar}"/>
                <param name="path" value="@{dest.dir}"/>
                <param name="md5"  value="${@{jarname}.md5}"/>
                <param name="_checkMD5" value="true"/>
            </antcall>
            <antcall target="_check_jarfile">
                <param name="loc" value="${@{jarname}.loc}"/>
                <param name="jar" value="${@{jarname}.jar}"/>
                <param name="path" value="@{dest.dir}"/>
                <param name="md5"  value="${@{jarname}.md5}"/>
                <param name="_checkMD5" value="true"/>
                <param name="zip" value="${@{jarname}.zip}"/>
                <param name="ent" value="${@{jarname}.ent}"/>
                <param name="zipprop" value="@{jarname}.zip"/>
            </antcall>
        </sequential>
    </macrodef>

    <!-- Check if jarfile exists, and set properties for calling zip or jar download -->
    <target name="_check_jarfile" if="_get_file">
        <!-- Check if file exists -->
        <fail message="Error in build file or calling sequence" if="file.exists"/>
        <echo level="info">Checking ${jar}</echo>
        <available file="${path}/${jar}" property="file.exists"/>
        <condition property="_get_zipfile">
            <isset property="${zipprop}"/>
        </condition>
        <condition property="_get_jarfile">
            <not>
                <isset property="${zipprop}"/>
            </not>
        </condition>
        <!-- Emulate conditional execution; targets use if/unless to suppress execution -->
        <antcall target="_get_jarfile"/>
        <antcall target="_get_zipfile"/>
    </target>

    <!-- Get a zip file and unpack it -->
    <target name="_get_zipfile" if="_get_zipfile" unless="file.exists">
        <get src="${loc}/${zip}"
             dest="${build.dir}/${zip}"
             usetimestamp="true" ignoreerrors="false"/>
        <unzip dest="${build.dir}" src="${build.dir}/${zip}">
            <patternset>
                <include name="**/${ent}"/>
            </patternset>
            <!-- This requires Ant 1.7.0 or later -->
            <mapper type="flatten"/>
        </unzip>
        <antcall target="_checkMD5">
            <param name="file" value="${ent}"/>
            <param name="path" value="${build.dir}"/>
            <param name="md5"  value="${md5}"/>
        </antcall>
        <move preservelastmodified="true" overwrite="true"
            file="${build.dir}/${ent}" tofile="${path}/${jar}" verbose="true"/>
    </target>

    <!-- Download a jar file and check its hash; if correct, move to correct directory -->
    <target name="_get_jarfile" if="_get_jarfile" unless="file.exists">
        <echo message="Fetching: ${path}/${jar}" level="info"/>
        <get src="${loc}/${jar}"
             dest="${build.dir}/${jar}"
             usetimestamp="false" ignoreerrors="false"/>
        <antcall target="_checkMD5">
            <param name="file" value="${jar}"/>
            <param name="path" value="${build.dir}"/>
            <param name="md5"  value="${md5}"/>
        </antcall>
        <move preservelastmodified="true" overwrite="true"
            file="${build.dir}/${jar}" tofile="${path}/${jar}" verbose="true"/>
    </target>

    <!-- Ant subroutine, required to localise MD5OK property -->
    <target name="_checkMD5" if="_checkMD5">
        <!--
        @param path - location of file
        @param file - file name
        -->
        <checksum algorithm="MD5" file="${path}/${file}" property="MD5"/>
        <condition property="MD5OK">
            <equals arg1="${MD5}" arg2="${md5}" casesensitive="false"/>
        </condition>
        <fail unless="MD5OK">Bad Checksum: for ${file}
        expected ${md5}
        actual   ${MD5}</fail>
        <echo level="info" message="Checksum OK: ${file}"/>
    </target>

    <!--
    Generic target to process all external jars.
    The "process_jarfile" macro resolves the properties that begin with the jarname
    and calls all the possible targets. The targets use "if" and "unless" to provide
    conditional execution (it would be a lot easier if antcall supported if/unless).
    -->
    <target name="_process_all_jars">
        <process_jarfile jarname="apache-bsf"/>
        <process_jarfile jarname="apache-jsr223-api"/>
        <process_jarfile jarname="avalon-framework"/>
        <process_jarfile jarname="bcmail" dest.dir="${lib.api}"/>
        <process_jarfile jarname="bcprov" dest.dir="${lib.api}"/>
        <process_jarfile jarname="beanshell"/>
        <process_jarfile jarname="commons-codec"/>
        <process_jarfile jarname="commons-collections"/>
        <process_jarfile jarname="commons-httpclient"/>
        <process_jarfile jarname="commons-io"/>
        <process_jarfile jarname="commons-jexl"/>
        <process_jarfile jarname="commons-jexl2"/>
        <process_jarfile jarname="commons-lang"/>
        <process_jarfile jarname="commons-logging"/>
        <process_jarfile jarname="commons-net"/>
        <process_jarfile jarname="excalibur-datasource"/>
        <process_jarfile jarname="excalibur-instrument"/>
        <process_jarfile jarname="excalibur-logger"/>
        <process_jarfile jarname="excalibur-pool"/>
        <process_jarfile jarname="htmllexer"/>
        <process_jarfile jarname="htmlparser"/>
        <process_jarfile jarname="httpclient"/>
        <process_jarfile jarname="httpmime"/>
        <process_jarfile jarname="httpcore"/>
        <process_jarfile jarname="jakarta-oro"/>
        <process_jarfile jarname="jcharts"/>
        <process_jarfile jarname="jdom"/>
        <process_jarfile jarname="js_rhino"/>
        <process_jarfile jarname="junit"/>
        <process_jarfile jarname="logkit"/>
        <process_jarfile jarname="soap"/>
        <process_jarfile jarname="tidy"/>
        <process_jarfile jarname="xstream"/>
        <process_jarfile jarname="xpp3"/>
        <process_jarfile jarname="serializer"/>
        <process_jarfile jarname="xalan"/>
        <process_jarfile jarname="xerces"/>
        <process_jarfile jarname="xml-apis"/>
        <process_jarfile jarname="xmlgraphics-commons"/>
        <process_jarfile jarname="activation"/>
        <process_jarfile jarname="javamail"/>
        <process_jarfile jarname="jms"/>
        <process_jarfile jarname="velocity"   dest.dir="${lib.doc}"/>
    </target>

    <!-- Download all missing jars.-->
    <target name="download_jars" description="Download any missing jar files">
        <!-- build.dir may be needed as a temporary work area -->
        <mkdir dir="${build.dir}" />
        <antcall target="_process_all_jars">
            <param name="_get_file" value="true"/>
        </antcall>
    </target>

    <target name="_check_exists" if="_check_exists">
        <fail message="Invalid call sequence - file.exists should not be defined" if="file.exists"/>
        <available file="${file}" property="file.exists"/>
        <fail message="Could not find file ${file}" unless="file.exists"/>
        <antcall target="_checkMD5">
            <param name="file" value="${jar}"/>
            <param name="path" value="${path}"/>
            <param name="md5"  value="${md5}"/>
        </antcall>
        <!--echo level="info" message="Found ${file}"/-->
    </target>

    <target name="check_jars" description="Check that all required jar files are present" unless="no_check_jars">
        <antcall target="_process_all_jars">
            <param name="_check_exists" value="true"/>
        </antcall>
    </target>

    <target name="checkstyle">
        <taskdef resource="checkstyletask.properties"
                 classpath="${lib.opt}/checkstyle-5.3-all.jar"/>
        <checkstyle config="checkstyle.xml">
          <fileset dir="src" includes="**/*.java"/>
          <formatter type="plain"/>
          <formatter type="xml" toFile="build/checkstyle_errors.xml"/>
        </checkstyle>

    </target>
  
    <target name="sign_dist"
      description="Sign release artifacts in dist and dist/maven.  Usage: ant sign_dist -Dgpg.keyname=key-id [-Dgpg.secretKeyring=path-to-keyring]      ">
      <scriptdef name="gpg" language="beanshell">
        <classpath>
          <pathelement location="${lib.dir}/${beanshell.jar}"/>
          <!-- Needed to work with Java 1.5 -->
          <pathelement location="${lib.dir}/${apache-bsf.jar}"/>
          <pathelement location="${lib.dir}/${commons-logging.jar}"/>
        </classpath>
        <element name="fileset" type="fileset"/>
        <![CDATA[
        int execcode( String command ) // helper 
        {
            StringTokenizer st = new StringTokenizer(command);
            String[] cmdarray = new String[st.countTokens()];
            for (int i = 0; st.hasMoreTokens(); i++) {
                cmdarray[i] = st.nextToken();
            }
            // Merge stderr with stdout so only have to fetch one stream
            proc = new ProcessBuilder(cmdarray).redirectErrorStream(true).start();
            din = new DataInputStream( proc.getInputStream() );
            while( (line=din.readLine()) != null ) {
                print(line);
            }
            return this.proc.waitFor();
        }
          keyname = project.getProperty("gpg.keyname");
          // Java 1.6 returns void, Java 1.5 returns null
          if (keyname == void || keyname == null) {
            self.fail("Please provide the gpg.keyname property");
          }
          keyring = project.getProperty("gpg.secretKeyring");
          if (keyring == void || keyring == null) {
            keyring = "secring.gpg"; // the default
          }
          sep=java.io.File.separator;
          cmd="gpg2 --batch --yes -ba -u " + keyname + " --secret-keyring " + keyring;
          self.log("Command: "+cmd);
          filesets = elements.get("fileset");
          for (i = 0; i < filesets.size(); ++i) {
            fileset = filesets.get(i);
            basedir = fileset.getDir();
            self.log("Processing "+basedir);
            ds = fileset.getDirectoryScanner();
            srcFiles = ds.getIncludedFiles();
            for (j=0; j < srcFiles.length; j++) {
              srcFile=srcFiles[j];
              file=basedir + sep + srcFile;
              self.log("Signing "+srcFile);
              ret=execcode(cmd+ " " + file);
              if (ret != 0) {
                 self.fail("Command failed: "+ret);
              }
            }
          }
        ]]>
      </scriptdef>
      <gpg>
        <fileset dir="${dist.dir}"  includes="*.*" excludes="*.asc *.md5 *.sha1 *.sha"/>
        <fileset dir="${maven.dir}" includes="*.*" excludes="*.asc *.md5 *.sha1 *.sha"/>
      </gpg>
    </target>
</project>
